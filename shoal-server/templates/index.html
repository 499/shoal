{% extends base.html %}

{% block head%}
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <style type="text/css">
		#map {
		  width: 50%;
		  height: 50%;
		  margin: 0;
		  padding: 0;
		}

		.stations, .stations svg {
		  position: absolute;
		}

		.stations svg {
		  width: 60px;
		  height: 20px;
		  padding-right: 100px;
		  font: 10px sans-serif;
		}

		.stations circle {
		  fill: brown;
		  stroke: black;
		  stroke-width: 1.5px;
		}
    </style>
{% end %}

{% block map %}
<div id="map"></div>
<script type="text/javascript">

	// Create the Google Map…
	var map = new google.maps.Map(d3.select("#map").node(), {
	  zoom: 3,
	  center: new google.maps.LatLng(23.75, -10),
	  mapTypeId: google.maps.MapTypeId.TERRAIN
	});

	// Load the station data. When the data comes back, create an overlay.
	d3.json("/nearest/1000", function(data) {
	  var overlay = new google.maps.OverlayView();
		
	  // Add the container when the overlay is added to the map.
	  overlay.onAdd = function() {
		var layer = d3.select(this.getPanes().overlayLayer).append("div")
			.attr("class", "stations");
		// Draw each marker as a separate SVG element.
		// We could use a single SVG, but what size would it have?
		overlay.draw = function() {
		  var projection = this.getProjection(),
			  padding = 10;

		  var marker = layer.selectAll("svg")
			  .data(d3.entries(data))
			  .each(transform) // update existing markers
			.enter().append("svg:svg")
			  .each(transform)
			  .attr("class", "marker");

		  // Add a circle.
		  marker.append("svg:circle")
			  .attr("r", 4.5)
			  .attr("cx", padding)
			  .attr("cy", padding);

		  // Add a label.
		  marker.append("svg:text")
			  .attr("x", padding + 7)
			  .attr("y", padding)
			  .attr("dy", ".31em")
			  .text(function(d) { return d.key; });

		  function transform(d) {
			var geoData = d.value[0].geo_data;
			d = new google.maps.LatLng(geoData.latitude, geoData.longitude);
			//var copy = d;
			//d = new google.maps.LatLng(d.value[1], d.value[0]);
			d = projection.fromLatLngToDivPixel(d);
			return d3.select(this)
				.style("left", (d.x - padding) + "px")
				.style("top", (d.y - padding) + "px");
		  }
		};
	  };

	  // Bind our overlay to the map…
	  overlay.setMap(map);
	});
</script>
{% end %}

{% block body %}
<div class="row-fluid">
    <div class="span6 offset3" style="text-align:center">

        <h2>List of Active Squids</h2>
        {% if len(shoal) > 0 %}
            <h5 class="text-success">{{len(shoal)}} active in the last {{inactive_time}} seconds</h5>
        {% else %}
            <h5 class="text-info">None active in the last {{inactive_time}} seconds</h5>
        {% end %}
        </div>
<div class="row-fluid">
  <div class='span12'>
    <table class="table table-condensed table-hover">
      <thead>
        <tr>
          <th>#</th>
          <th>Hostname</th>
          <th class="hidden-phone">Public IP</th>
          <th class="hidden-phone">Private IP</th>
          <th>Bytes Out</th>
          <th>City</th>
          <th>Region</th>
          <th class="hidden-phone">Country</th>
          <th class="hidden-phone">Latitude</th>
          <th class="hidden-phone">Longitude</th>
          <th class="hidden-phone">Last Received</th>
          <th>Alive</th>
        </tr>
      </thead>
      <tbody>
        {% for squid in xrange(len(shoal)) %}
            {% set last_msg = int(int(now) - shoal[squid]['last_active']) %}
            {% set alive_time = int(now - shoal[squid]['timestamp']) %}
            {% set hour = int(alive_time/60/60) %}
            {% set minute = (alive_time - hour*60*60) / 60 %}
            {% set second = alive_time - hour*60*60 - minute*60 %}
            {% set status = 'success' %}
            {% if last_msg < inactive_time/3 %}
                {% set state = 'success' %}
            {% elif last_msg >= inactive_time/3 and last_msg < inactive_time*2/3 %}
                {% set state = 'warning' %}
            {% else %}
                {% set state = 'error' %}
            {% end %}

            <tr class='{{(state)}}'>
                <td><span class="badge badge-{{(state)}}">{{(squid+1)}}</td>
                <td>{{shoal[squid]['hostname']}}</td>
                <td class="hidden-phone">{{shoal[squid]['public_ip']}}</td>
                <td class="hidden-phone">{{shoal[squid]['private_ip']}}</td>
                <td>{{shoal[squid]['load']}} kB/s</td>
                <td>{{shoal[squid]['geo_data']['city']}}</td>
                <td class="hidden-phone">{{shoal[squid]['geo_data']['country_code3']}}</td>
                <td>{{shoal[squid]['geo_data']['region_code']}}</td>
                <td class="hidden-phone">{{shoal[squid]['geo_data']['latitude']}}</td>
                <td class="hidden-phone">{{shoal[squid]['geo_data']['longitude']}}</td>
                <td class="hidden-phone">{{(last_msg)}}s</td>
                <td>{{(hour)}}h {{(minute)}}m {{(second)}}s</td>
            </tr>
        {% end %}
      </tbody>
    </table>
  </div>
</div>
{% end %}
